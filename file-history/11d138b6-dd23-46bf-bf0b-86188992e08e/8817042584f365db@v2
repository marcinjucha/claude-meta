# Login Screen

## Overview

User authentication screen - email/password login with optional environment selection (staging/production/custom).

## Architecture

**NOT TCA-based** - Uses traditional MVVM with `LoginViewModel` protocol.

**Files:**
- **View:** `LoginView.swift`
- **ViewModel:** `LoginViewModel.swift`, `ShelfLoginViewModel.swift`

## LoginViewModel Protocol

```swift
protocol LoginViewModel: ObservableObject {
    var canLogin: Bool { get }
    var isLoading: Bool { get }
    var email: String { get set }
    var password: String { get set }
    var error: ErrorAlert? { get set }
    var availableEnvironments: [AppEnvironment] { get }
    var canSelectEnvironment: Bool { get set }
    var selectedEnvironmentId: AppEnvironment.ID { get set }
    var needsUserInput: Bool { get }
    var customEnvironmentURL: String { get set }

    func load()
    func login()
}
```

## View Structure

### Main Components
1. **Header** - App title with secret tap gesture (5 taps → enable environment selection)
2. **Environment Selection** (conditional) - Segmented picker + custom URL field
3. **Login Fields** - Email + password with show/hide toggle
4. **Login Button** - Disabled when `!canLogin`

### Key Features

**Secret Environment Selection:**
```swift
Text(L10n.Login.header)
    .onTapGesture(count: 5) {
        viewModel.canSelectEnvironment.toggle()
    }
```

**Password Toggle:**
```swift
@State var isPasswordHidden = true

Button(action: { isPasswordHidden.toggle() }) {
    Image(systemName: isPasswordHidden ? "eye.slash" : "eye")
}
```

**Keyboard Handling:**
```swift
@State private var showBottomPadding = false
private let bottomPaddingWithKeyboard: CGFloat = 300

.onReceive(Publishers.keyboardAnimationInfo) { info in
    showBottomPadding = info.bottomPadding > bottomPaddingThreshold
}
```

## Validation

**Login Enabled When:**
- Email is non-empty + valid format
- Password is non-empty + min 6 characters
- Not currently loading

## Localization

**L10n Keys:**
- `L10n.Login.header` - Screen title
- `L10n.Field.Email.title/placeholder` - Email field
- `L10n.Field.Password.title/placeholder` - Password field
- `L10n.Field.environment` - Environment picker
- `L10n.Field.Environment.title/placeholder` - Custom URL field
- `L10n.Action.login` - Login button

## App Environments

```swift
enum AppEnvironment: String, CaseIterable, Identifiable {
    case production
    case staging
    case customStaging

    var id: String { rawValue }
    var name: String { ... }
}
```

## Authentication Flow

1. User enters credentials
2. Optionally selects environment (secret gesture)
3. ViewModel validates input → `canLogin` updates
4. User taps login button → `viewModel.login()`
5. ViewModel shows loading spinner
6. On success → Navigate to Home (via `RootViewModel`)
7. On failure → Show error alert

## Error Handling

```swift
.alert(item: $viewModel.error) { error in
    Alert(title: Text(error.title))
}
```

## Design System Usage

- **Button Style:** `.scanditButtonStyle()`
- **Fonts:** `Constants.Fonts.screenHeader`, `.textFieldTitle`, `.buttonTitle`
- **Colors:** `Colors.textFieldTitle`, `.textFieldLine`
- **Activity Indicator:** `ActivityIndicator(style: .medium)`

## Implementation Notes

**NOT TCA Pattern:**
- Uses `@ObservedObject` instead of TCA Store
- Uses `@State` for local UI state
- Direct property bindings with `$viewModel.email`
- Traditional protocol-based MVVM

**Why Not TCA?**
- Login is a simple, isolated flow
- No complex state management needed
- No child features to compose
- Legacy code pre-dating full TCA adoption

## Testing

**Mock ViewModel:**
```swift
#if DEBUG
final class MockedLoginViewModel: LoginViewModel {
    var canLogin: Bool = false
    var isLoading: Bool = false
    var email: String = "john@scandit.com"
    var password: String = "admin"
    var error: ErrorAlert?
    // ...

    func load() {}
    func login() {}
}
#endif
```

## Dependencies

- `AccountStorage` - Authentication service
- `FirebaseAnalytics` - Track login attempts
- `UserRepository` - User data after login

## Common Pitfalls

- ❌ Don't forget to call `viewModel.load()` in `.onAppear`
- ❌ Don't hardcode environment URLs - use `AppEnvironment` enum
- ✅ Always validate email format + password length
- ✅ Disable button during loading state
- ✅ Use L10n constants for all strings
