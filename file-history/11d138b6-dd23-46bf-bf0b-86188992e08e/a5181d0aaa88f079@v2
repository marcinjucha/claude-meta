# Settings Screen

## Overview

App settings, user account info, environment details, logout, and app/SDK version information.

## Architecture

**NOT TCA-based** - Uses traditional MVVM with `SettingsViewModel` protocol.

**Files:**
- **View:** `SettingsView.swift`, `AppSettingsView.swift`, `LogView.swift`
- **ViewModel:** `SettingsViewModel.swift`, `ShelfSettingsViewModel.swift`, `AppSettingsViewModel.swift`
- **Feedback:** `FeedbackView.swift`, `FeedbackViewModel.swift`, `FeedbackButton.swift`
- **Feedback Business:** `FeedbackUseCase.swift`, `FeedbackZendeskRepository.swift`

## SettingsViewModel Protocol

```swift
protocol SettingsViewModel: ObservableObject {
    var environment: String { get }
    var appVersion: String { get }
    var sdkVersion: String { get }
    var userName: String { get }
    var userEmail: String { get }
    var detailedVersion: String? { get }

    func secretTap()  // SDK version tap → show detailed version
    func logout()
    func onDisappear()
}
```

## View Structure

### Main Components

**1. Navigation Bar**
```swift
.scanditNavigationBar(title: L10n.settings)
.navigationBarTitleDisplayMode(.inline)
.toolbar {
    ToolbarItem(placement: .topBarTrailing) {
        Image(systemName: "square.and.arrow.up")
            .onTapGesture { showExportDialog = true }
    }
}
```

**2. Settings Sections**
```swift
TableSection(title: L10n.about, items: [
    .init(title: L10n.appVersion, value: viewModel.appVersion),
    .init(title: L10n.sdkVersion, value: viewModel.sdkVersion, action: { viewModel.secretTap() }),
    .init(title: L10n.sdkEngineVersion, value: viewModel.detailedVersion),
    .init(title: L10n.acknowledgment, action: { /* Open Settings.app */ }),
    .init(title: L10n.appSettings, action: { showAppSettings.toggle() })
])

TableSection(title: L10n.account, items: [
    .init(title: L10n.environment, value: viewModel.environment),
    .init(title: L10n.userName, value: viewModel.userName),
    .init(title: L10n.email, value: viewModel.userEmail)
])
```

**3. Logout Button**
```swift
Button(action: {}, label: {
    Text(L10n.Action.logout.uppercased())
})
.scanditButtonStyle()
.alert(isPresented: $isLogoutConfirmationVisible) {
    Alert(
        title: Text(L10n.Action.Logout.confirmation),
        primaryButton: .cancel(),
        secondaryButton: .destructive(
            Text(L10n.Action.confirm),
            action: { viewModel.logout() }
        )
    )
}
```

## TableSection Model

```swift
struct TableSection: Identifiable {
    let id = UUID()
    let title: String
    let items: [Item]

    struct Item: Identifiable {
        let id = UUID()
        let title: String
        let value: String?
        let action: (() -> Void)?
    }
}
```

## Key Features

### 1. Secret Tap
Tap SDK version → Show detailed engine version (if available)

### 2. Copy to Clipboard
Long-press any value → Context menu → Copy

```swift
.contextMenu(ContextMenu {
    Button(L10n.Action.copy) {
        if let value = item.value {
            UIPasteboard.general.string = value
        }
    }
})
```

### 3. Log Export
Top-right toolbar button → Export logs sheet

```swift
.sheet(isPresented: $showExportDialog) {
    LogView()
}
```

### 4. App Settings
Navigate to `AppSettingsView` for advanced settings

```swift
.sheet(isPresented: $showAppSettings) {
    AppSettingsView()
}
```

### 5. Acknowledgment
Opens iOS Settings.app → App-specific settings → Licenses

```swift
UIApplication.shared.open(URL(string: UIApplication.openSettingsURLString)!)
```

## Localization

**L10n Keys:**
- `L10n.settings` - Screen title
- `L10n.about` - About section
- `L10n.account` - Account section
- `L10n.appVersion/sdkVersion/sdkEngineVersion` - Version labels
- `L10n.acknowledgment/appSettings` - Item titles
- `L10n.environment/userName/email` - Account labels
- `L10n.Action.logout/confirm` - Logout actions
- `L10n.Action.Logout.confirmation` - Logout alert
- `L10n.Action.copy` - Context menu

## Logout Flow

1. User taps logout button
2. Confirmation alert appears
3. User confirms → `viewModel.logout()`
4. ViewModel clears session + navigates to Login
5. Handled by `RootViewModel`

## Feedback Feature

### FeedbackView
- User can submit feedback to Zendesk
- Captures device info, logs, screenshots
- Uses `FeedbackUseCase` + `FeedbackZendeskRepository`

### FeedbackButton
- Reusable button component
- Shows feedback sheet when tapped

### FeedbackUseCase
```swift
protocol AnyFeedbackUseCase {
    func submitFeedback(message: String, attachments: [Data]) async throws
}
```

## Design System Usage

- **Button Style:** `.scanditButtonStyle()`
- **Fonts:** `Constants.Fonts.sectionHeader`, `.itemTitle`, `.itemValue`, `.buttonTitle`
- **Navigation Bar:** `.scanditNavigationBar(title:)`
- **Colors:** Generated by SwiftGen

## Dependencies

- `AccountStorage` - Logout
- `UserRepository` - User info (name, email)
- `ConfigurationRepository` - Environment info
- `SDKVersionProvider` - SDK versions
- `FirebaseAnalytics` - Track logout events (via `onDisappear`)

## Common Pitfalls

- ❌ Don't forget to call `viewModel.onDisappear()` in `.onDisappear`
- ❌ Don't use hardcoded strings - use L10n constants
- ✅ Always show confirmation alert before logout
- ✅ Use `.highPriorityGesture` for logout button to prevent sheet dismiss conflicts
- ✅ Handle optional `detailedVersion` with `.compactMap { $0 }`

## Testing

**Mock ViewModel:**
```swift
#if DEBUG
final class MockedSettingsViewModel: SettingsViewModel {
    var environment: String = "shelf.scandit.com"
    var appVersion: String = "1.2.3"
    var sdkVersion: String = "4.5.6"
    var userName: String = "John Snow"
    var userEmail: String = "john.snow@scandit.com"
    var detailedVersion: String?

    func secretTap() {}
    func logout() {}
    func onDisappear() {}
}
#endif
```

## Implementation Notes

**NOT TCA Pattern:**
- Uses `@ObservedObject` instead of TCA Store
- Uses `@State` for local UI state (alerts, sheets)
- Traditional protocol-based MVVM
- Legacy code pre-dating full TCA adoption

**Why Not TCA?**
- Settings is mostly static data display
- No complex state management needed
- No child features to compose (Feedback is separate MVVM)
