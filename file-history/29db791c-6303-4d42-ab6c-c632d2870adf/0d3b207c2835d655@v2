import { TallyWebhookPayload } from "@/features/survey/logic/survey-type"
import { processTallyWebhookUseCase } from "@/features/survey/logic/survey-use-case"
import {
  saveSurveyResultRepository,
  evaluateTallyResponse,
} from "@/features/survey/logic/survey-repo"
import { NextRequest, NextResponse } from "next/server"

export async function POST(request: NextRequest) {
  try {
    // Pobierz dane z webhook
    const body: TallyWebhookPayload = await request.json()

    console.log("Received webhook:", {
      eventId: body.eventId,
      respondentId: body.data.respondentId,
      formName: body.data.formName,
    })

    // Przetwórz webhook przez use case
    const result = await processTallyWebhookUseCase({
      context: {
        saveSurveyResult: saveSurveyResultRepository,
        evaluateTallyResponse: evaluateTallyResponse,
      },
      data: body,
    })

    if (result.isFailure) {
      console.error("Failed to process webhook:", result.error)
      return NextResponse.json({ error: result.error }, { status: 500 })
    }

    console.log("Survey processed successfully:", result.value)

    return NextResponse.json({
      success: true,
      surveyId: result.value.id,
      result: result.value.result,
    })
  } catch (error) {
    console.error("Webhook error:", error)
    return NextResponse.json({ error: "Internal server error" }, { status: 500 })
  }
}

// Opcjonalnie: obsługa GET dla odczytywania zapisanych ankiet
export async function GET(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url)
    const id = searchParams.get("id")

    console.log("GET request - surveyID:", id)

    if (!id) {
      return NextResponse.json(
        {
          error: "id parameter is required (surveyID/respondentId)",
          example: "?id=your-survey-id",
        },
        { status: 400 },
      )
    }

    // Użyj use case do pobrania danych z CMS
    const { getSurveyResultUseCase } = await import("@/features/survey/logic/survey-use-case")
    const { getSurveyResultRepository } = await import("@/features/survey/logic/survey-repo")

    const result = await getSurveyResultUseCase({
      context: {
        getSurveyResult: getSurveyResultRepository,
      },
      data: { id },
    })

    if (result.isFailure) {
      console.log(`Survey not found for id: ${id}`)
      return NextResponse.json(
        {
          error: "Survey not found",
          id,
        },
        { status: 404 },
      )
    }

    console.log("=== SURVEY DATA FROM CMS ===")
    console.log("Survey ID:", result.value.id)
    console.log("Result:", result.value.result)
    console.log("Email:", result.value.email)
    console.log("Submitted At:", result.value.submittedAt)
    console.log("Tally Response ID:", result.value.tallyResponseId)
    console.log("=== END SURVEY DATA ===")

    return NextResponse.json({
      message: "Survey data found in CMS",
      data: result.value,
      timestamp: new Date().toISOString(),
    })
  } catch (error) {
    console.error("GET endpoint error:", error)
    return NextResponse.json(
      {
        error: "Internal server error",
        details: error instanceof Error ? error.message : "Unknown error",
      },
      { status: 500 },
    )
  }
}
