---
globs: DigitalShelf/Screens/Home/**
---
# Home Module Architecture Rules

## ðŸ”‘ Keywords & Usage

**This rule automatically applies when working in `DigitalShelf/Screens/Home/**`, but you can use it when you write:**
- "home", "home screen", "main screen"
- "mode", "mode selection", "scan mode"
- "home feature", "mode configuration"
- Working in Home directory

**Example prompts:**
- "Add new mode to home screen"
- "Show available modes"
- "Update home screen navigation"
- "Fix home screen initialization"

---

## Component Responsibilities
- **HomeUseCase**: Stateless orchestrator - delegates to HomeModeService
- **HomeModeService**: Stateful service - mode creation, filtering, configuration
- **HomeModeConfigurationRepository**: Pure data access - config and products
- **StoreSelectionFeature**: Child TCA feature via Scope

## TCA Patterns

### Initialize Pattern
- **Rule**: Guard `!loaded` â†’ set `loaded = true` â†’ merge publishers + actions
- **Why**: Prevents duplicate initialization and ensures proper lifecycle management
- **Usage**: Use when feature needs one-time setup with multiple async data sources
- **Gotchas**: Always guard against `loaded` flag to prevent duplicate subscriptions
- **Reference**: `HomeStore.swift`

### Child Features
- **Rule**: BindingReducer first, then Scope for children, then main Reduce logic
- **Why**: BindingReducer handles SwiftUI bindings, Scope isolates child state management
- **Usage**: Use Scope for permanent children, ifLet for optional/conditional children
- **Gotchas**: Wrong order breaks bindings; missing BindingReducer loses SwiftUI integration
- **Reference**: `HomeStore.swift`

## Dependencies

### Service Pattern (Multiple Repositories)
- **Rule**: HomeModeService combines 3 repositories with specific business logic
- **Why**: Prevents dependency cycles between repositories + centralizes mode creation logic
- **Usage**: When need to combine multiple data sources with domain-specific algorithms
- **Gotchas**: Don't inject repositories into other repositories (creates cycles)
- **Decision Criteria**: Use Service when combining 2+ repositories OR complex business logic
- **Reference**: `HomeModeService.swift`

### Repository Pattern
- **Rule**: Pure data access without cross-repository dependencies
- **Why**: Maintains clean separation and prevents circular dependencies
- **Usage**: One repository per data source (database, API, UserDefaults)
- **Gotchas**: Never inject other repositories - use Service layer instead
- **Decision Criteria**: Use Repository for single data source operations only
- **Reference**: `HomeModeConfigurationRepository.swift`

## Navigation

### Navigation Dependencies
- **Rule**: Inject navigation service via @Dependency + use specific destination types
- **Why**: Decouples navigation from view hierarchy + prevents parent/child conflicts
- **Usage**: Use specific types for shared views, avoid generic NavigationDestination in parents
- **Gotchas**: Parent using NavigationDestination.self breaks child navigation
- **Decision Criteria**: Specific types for parent-managed views, generic for child modules
- **Reference**: `HomeStore.swift`