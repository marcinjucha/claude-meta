#!/bin/bash
set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
WORKSPACE="DigitalShelf.xcworkspace"
SCHEME="DigitalShelf"
DESTINATION="platform=iOS Simulator,name=iPhone 15 Pro,OS=latest"
TEST_FILTER="${1:-}"

# Helper functions
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# Find DerivedData path
find_derived_data() {
    local derived_data=$(xcodebuild -showBuildSettings -workspace "$WORKSPACE" -scheme "$SCHEME" 2>/dev/null | grep "BUILD_DIR" | head -1 | awk -F' = ' '{print $2}')

    if [[ -z "$derived_data" ]]; then
        log_error "Could not find DerivedData path"
        exit 1
    fi

    # Extract DerivedData root (remove /Build/Products)
    echo "$derived_data" | sed 's|/Build/Products||'
}

# Build xcodebuild command with test filter
build_test_command() {
    local cmd="xcodebuild test -workspace $WORKSPACE -scheme $SCHEME -destination '$DESTINATION'"

    if [[ -n "$TEST_FILTER" ]]; then
        log_info "Running tests matching: $TEST_FILTER"
        cmd="$cmd -only-testing:DigitalShelfTests/$TEST_FILTER"
    else
        log_info "Running all tests"
    fi

    # Preserve DerivedData (no clean)
    cmd="$cmd 2>&1"

    echo "$cmd"
}

# Parse test results
parse_results() {
    local output="$1"
    local passed=0
    local failed=0
    local total=0

    # Count results
    passed=$(echo "$output" | grep -c "Test Case.*passed" || true)
    failed=$(echo "$output" | grep -c "Test Case.*failed" || true)
    total=$((passed + failed))

    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo -e "${BLUE}ğŸ“Š Test Results${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    if [[ $failed -eq 0 ]]; then
        log_success "All tests passed! ($passed/$total)"
    else
        log_error "$failed/$total tests failed"
    fi

    # Show execution time
    local duration=$(echo "$output" | grep "Test session.*seconds" | sed -E 's/.*\(([0-9.]+) seconds\).*/\1/')
    if [[ -n "$duration" ]]; then
        log_info "Total time: ${duration}s"
    fi

    # Show failed tests
    if [[ $failed -gt 0 ]]; then
        echo ""
        echo -e "${RED}Failed Tests:${NC}"
        echo "$output" | grep -A 2 "Test Case.*failed" | grep -v "^--$"
    fi

    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    return $failed
}

# Main execution
main() {
    echo -e "${BLUE}â„¹ï¸  Starting test run...${NC}"

    # Check workspace exists
    if [[ ! -d "$WORKSPACE" ]]; then
        echo -e "${RED}âŒ Workspace not found: $WORKSPACE${NC}"
        exit 1
    fi

    # Find DerivedData path
    local derived_data=$(find_derived_data)
    echo -e "${BLUE}â„¹ï¸  Using DerivedData: $derived_data${NC}"

    # Build test command
    local test_cmd=$(build_test_command)

    # Run tests
    echo -e "${BLUE}â„¹ï¸  Running tests...${NC}"
    echo ""

    # Execute and capture output
    local output
    local exit_code=0
    if output=$(eval "$test_cmd" 2>&1); then
        parse_results "$output"
        exit_code=$?
    else
        # Test failures
        parse_results "$output"
        exit_code=1
    fi

    exit $exit_code
}

# Run main
main
