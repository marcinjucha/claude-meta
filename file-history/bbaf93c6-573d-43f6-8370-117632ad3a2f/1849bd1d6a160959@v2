//  Copyright Â© 2025 Scandit. All rights reserved.

@testable import DigitalShelf
import ComposableArchitecture
import XCTest
import UIKit

@MainActor
final class MappingModeModulePreviewUseCaseTests: XCTestCase {

    // MARK: - Properties

    private lazy var fakeRepository = FakeModulePreviewRepository()
    private lazy var sut = MappingModeModulePreviewUseCase.makeWithDeps(
        previewRepository: fakeRepository
    )

    private let testModuleId = 123
    private let testImage = UIImage(systemName: "photo")!

    // MARK: - Happy Path Tests

    func testLoadModulePreviewShouldCallRepositoryWithCorrectModuleId() async throws {
        // Given
        fakeRepository.stubbedPreviewResult = (
            cached: nil,
            fresh: Task { self.testImage }
        )

        // When
        _ = try await sut.loadModulePreview(moduleId: testModuleId)

        // Then
        XCTAssertEqual(fakeRepository.invokedPreviewCount, 1)
        XCTAssertEqual(fakeRepository.invokedPreviewParameters, testModuleId)
    }

    func testLoadModulePreviewShouldReturnTupleWithCachedAndFreshTask() async throws {
        // Given
        let cachedImage = UIImage(systemName: "star")!
        let freshImage = testImage
        fakeRepository.stubbedPreviewResult = (
            cached: cachedImage,
            fresh: Task { freshImage }
        )

        // When
        let (cached, freshTask) = try await sut.loadModulePreview(moduleId: testModuleId)

        // Then
        XCTAssertNotNil(cached)
        XCTAssertEqual(cached?.size, cachedImage.size)

        let fresh = try await freshTask.value
        XCTAssertNotNil(fresh)
        XCTAssertEqual(fresh.size, freshImage.size)
    }

    func testLoadModulePreviewWithNoCachedImageShouldReturnNilCached() async throws {
        // Given
        fakeRepository.stubbedPreviewResult = (
            cached: nil,
            fresh: Task { self.testImage }
        )

        // When
        let (cached, freshTask) = try await sut.loadModulePreview(moduleId: testModuleId)

        // Then
        XCTAssertNil(cached)

        let fresh = try await freshTask.value
        XCTAssertNotNil(fresh)
    }

    // MARK: - Error Handling Tests

    func testLoadModulePreviewShouldPropagateRepositoryErrors() async {
        // Given
        fakeRepository.stubbedPreviewError = ModulePreviewError.networkUnavailable

        // When/Then
        do {
            _ = try await sut.loadModulePreview(moduleId: testModuleId)
            XCTFail("Expected error to be thrown")
        } catch {
            XCTAssertEqual(error as? ModulePreviewError, .networkUnavailable)
        }
    }

    func testLoadModulePreviewWithEmptyImageErrorShouldPropagate() async {
        // Given
        fakeRepository.stubbedPreviewError = ModulePreviewError.emptyImage

        // When/Then
        do {
            _ = try await sut.loadModulePreview(moduleId: testModuleId)
            XCTFail("Expected error to be thrown")
        } catch {
            XCTAssertEqual(error as? ModulePreviewError, .emptyImage)
        }
    }

    func testLoadModulePreviewWithTooManyRequestsErrorShouldPropagate() async {
        // Given
        fakeRepository.stubbedPreviewError = ModulePreviewError.tooManyRequests

        // When/Then
        do {
            _ = try await sut.loadModulePreview(moduleId: testModuleId)
            XCTFail("Expected error to be thrown")
        } catch {
            XCTAssertEqual(error as? ModulePreviewError, .tooManyRequests)
        }
    }

    // MARK: - Multiple Calls Tests

    func testMultipleLoadModulePreviewCallsShouldCallRepositoryMultipleTimes() async throws {
        // Given
        fakeRepository.stubbedPreviewResult = (
            cached: nil,
            fresh: Task { self.testImage }
        )

        // When
        _ = try await sut.loadModulePreview(moduleId: testModuleId)
        _ = try await sut.loadModulePreview(moduleId: testModuleId)

        // Then
        XCTAssertEqual(fakeRepository.invokedPreviewCount, 2)
    }

    func testLoadModulePreviewWithDifferentModuleIdsShouldPassCorrectIds() async throws {
        // Given
        let moduleId1 = 123
        let moduleId2 = 456
        fakeRepository.stubbedPreviewResult = (
            cached: nil,
            fresh: Task { self.testImage }
        )

        // When
        _ = try await sut.loadModulePreview(moduleId: moduleId1)
        _ = try await sut.loadModulePreview(moduleId: moduleId2)

        // Then
        XCTAssertEqual(fakeRepository.invokedPreviewCount, 2)
        XCTAssertEqual(fakeRepository.invokedPreviewParametersList[0], moduleId1)
        XCTAssertEqual(fakeRepository.invokedPreviewParametersList[1], moduleId2)
    }

    // MARK: - Fresh Task Tests

    func testLoadModulePreviewFreshTaskShouldBeExecutableIndependently() async throws {
        // Given
        let cachedImage = UIImage(systemName: "star")!
        let freshImage = UIImage(systemName: "heart")!
        fakeRepository.stubbedPreviewResult = (
            cached: cachedImage,
            fresh: Task {
                try await Task.sleep(for: .milliseconds(10))
                return freshImage
            }
        )

        // When
        let (cached, freshTask) = try await sut.loadModulePreview(moduleId: testModuleId)

        // Then - Cached should be available immediately
        XCTAssertNotNil(cached)
        XCTAssertEqual(cached?.size, cachedImage.size)

        // Fresh task should complete independently
        let fresh = try await freshTask.value
        XCTAssertNotNil(fresh)
        XCTAssertEqual(fresh.size, freshImage.size)
    }
}
