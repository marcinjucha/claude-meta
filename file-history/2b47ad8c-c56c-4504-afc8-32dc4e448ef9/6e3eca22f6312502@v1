# Test Infrastructure Guide

Quick reference for writing tests in the DigitalShelf iOS project.

## Test Samples - Create Test Data Fast

**Purpose:** Factory methods to create domain models with sensible defaults.

**Location Pattern:** `DigitalShelfTests/Utils/TestSamples+*.swift`

### Basic Types (`TestSamples.swift`)
```swift
String.randomValue        // 8-char random string
Int.randomValue          // Random 100-10000
Data.randomValue         // Random data
URL.randomValue          // Random https URL
Date.randomValue         // Random future date
UIImage.randomValue      // 10x10 random color
GenericError()           // Generic test error
```

### Models (`TestSamples+Models.swift`)
```swift
Store.sample(id: 1, name: "Test Store")
Product.sample(id: 123, name: "Product", code: "ABC")
ShelfScanAisle.sample
ShelfScanModule.sample(id: 1, reference: "M1")
CaptureSessionResult.sample()
CaptureSessionImage.sample()
ModuleIdentity.sample(store: 1, moduleId: 100)
GroupCardModel.sample(id: 1, name: "Aisle 1")
```

### Database Records (`TestSamples+Database.swift`)
```swift
UploadRequestRecord.sample(status: .success)
SessionRecord.sample(aisleId: 1, moduleId: 100)
SessionModuleRecord.sample()
ImageRecord.sample(session: session, request: request)
```

### Network (`TestSamples+Network.swift`)
```swift
URLRequest.randomValue
HTTPURLResponse.sample(statusCode: 200)
CaptureSessionEndpoint.sample(token: "abc")
GCUploadCaptureSessionResponse.sample()
```

### Routes (`TestSamples+Routes.swift`)
```swift
Route.sample(id: 1, name: "Route", aisles: [])
RouteAisle.sample(id: 1, modules: [])
RouteAisleModule.sample(uploadStatus: .success)

// Predefined states
Route.routeWithPendingUploads
Route.routeWithSuccessfulUpload
Route.routeWithFailedUpload

// Mock API responses
RouteResponse.mockData
RouteDetailsResponse.mockRouteId1
```

**When to use:** Every test that needs domain models. Use `.sample()` with defaults, override only what matters for your test.

---

## Spies - Track Method Calls

**Purpose:** Verify methods were called with correct parameters.

**Pattern:** Track all invocations in `invoked*ParametersList`, count in `invoked*Count`.

### KeyValueStorageSpy
```swift
let storage = KeyValueStorageSpy()
storage[.userId] = 123

XCTAssertEqual(storage.invokedSubscriptSetterCount, 1)
XCTAssertEqual(storage.invokedSubscriptList[.userId] as? Int, 123)
```
**Location:** `Mocks/KeyValueStorageSpy.swift`

### NavigationMock
```swift
let nav = NavigationMock()
nav.push(destination: .home)

XCTAssertEqual(nav.invokedPushDestinationCount, 1)
XCTAssertEqual(nav.invokedPushDestinationParametersList[0].destination, .home)
nav.assertPopCount(expectedCount: 2)
```
**Location:** `Mocks/NavigationMock.swift`

### FirebaseAnalyticsSpy
```swift
let analytics = FirebaseAnalyticsSpy()
analytics.log(event: LoginEvent())

XCTAssertEqual(analytics.invokedLogCount, 1)
```
**Location:** `Mocks/FirebaseAnalyticsSpy.swift`

### Upload Spies
- `UploadURLSessionSpy` - Track background upload sessions
- `UploadURLSessionTaskSpy` - Track individual upload tasks

**Location:** `Mocks/UploadURLSession*.swift`

### Use Case Spies
- `RouteRootUseCaseSpy` - Track route root use case
- `RouteDetailsUseCaseSpy` - Track route details use case
- `RouteListUseCaseSpy` - Track route list use case
- `RouteReuploadSpy` - Track reupload operations
- `MappingModuleListEditAisleNameUseCaseSpy` - Track aisle editing
- `MappingModeModulePreviewUseCaseSpy` - Track module preview

**Location:** `Routes/Mocks/*Spy.swift`, `MappingFlow/*Spy.swift`

**When to use:** TCA Presentation tests - verify use cases and navigation were called correctly.

---

## Mocks - Control Behavior

**Purpose:** Full protocol implementations with configurable responses. Combine tracking (spy) + stubbing (return values).

### FakeHttpService
```swift
let http = FakeHttpService()

// Success response
http.addRequest(endpoint: .products, data: [Product.sample()])

// Failure response
http.addFailure(endpoint: .stores, error: GenericError())

// Async/await
let products = try await http.request(endpoint: ProductsEndpoint())

// Combine publisher
http.request(endpoint: StoresEndpoint())
    .sink { stores in /* ... */ }

// Track background uploads
XCTAssertEqual(http.backgroundUploadCount, 1)
```
**Location:** `Mocks/FakeHttpService.swift`

**Features:**
- Publisher-based responses per endpoint
- Supports async/await and Combine
- Track background uploads
- Predefined endpoints: `.config`, `.products`, `.productsStores`, `.logout`

### MockFileManager
```swift
let fileManager = MockFileManager()

// Stub file exists
fileManager.fileExistsResult = true

// Stub file contents
fileManager.contentsResult["path/to/file.json"] = jsonData

// Verify file was created
XCTAssertEqual(fileManager.createFileCalls.count, 1)
XCTAssertEqual(fileManager.createFileCalls[0].path, "expected/path")

// Stub directory error
fileManager.createDirectoryError = GenericError()
```
**Location:** `Mocks/MockFileManager.swift`

**Features:**
- Mock all FileManager operations
- Configurable documents directory
- Path normalization helpers
- Track all file operations

### Other Mocks
- `ShelfAisleStorageMock` - Mock aisle persistence
- `APITokenProviderMock` - Mock authentication tokens
- `RouteNetworkRepositoryMock` - Mock route network calls

**When to use:** Business integration tests - test data flow with real business logic but mocked external dependencies (network, filesystem).

---

## Fakes - Simplified Implementations

**Purpose:** Working but simplified implementations (not full production code).

- `FakeDeviceMotionManager` - Fake motion sensor
- `FakeLabelCapturePublisher` - Fake Scandit label capture
- `FakeSinglePlvCaptureSessionManager` - Fake PLV capture
- `MockBarcodeCaptureAdapter` - Fake barcode scanning

**When to use:** Test SDK-dependent features without SDK.

---

## Database Test Utils

**Location:** `Extensions/Database+TestUtils.swift`

```swift
// Add records
let session = try db.addSessionRecord(.sample())
let module = try db.addSessionModuleRecord(.sample())

// Add upload request with all options
try db.addUploadRequestRecord(
    id: UUID(),
    sessionId: session.id,
    status: .success,
    retryCount: 2,
    withPayload: true
)

// Batch add
try db.addUploadRequestRecords(uuids: [id1, id2], status: .inProgress)

// Fetch records
let record = try db.uploadRequestRecord(forID: id)
let records = try db.uploadRequestRecords(forIDs: [id1, id2])
```

**When to use:** Quickly populate database state in business integration tests.

---

## TCA Testing with Test Doubles

**Location:** `Mocks/Dependency+TestDoubles.swift`

```swift
lazy var sut = TestStore(initialState: Feature.State()) {
    Feature()
} withDependencies: {
    $0.navigation = NavigationMock()
    $0.appAnalytics = .dummy  // Pre-configured with spies
    $0.useCase = UseCaseSpy()
}

func testOnAppear() async throws {
    await sut.send(.onAppear)
    await sut.receive(\.dataLoaded)

    XCTAssertEqual(navigation.invokedPushCount, 1)
    XCTAssertEqual(useCase.invokedFetchCount, 1)
}
```

**Pre-configured:**
- `AppAnalytics.dummy` - Includes `FirebaseAnalyticsSpy`, `KeyValueStorageSpy`, `DateProvider`

**When to use:** All TCA presentation tests.

---

## Quick Decision Tree

**Need test data?**
→ Use `.sample()` from `TestSamples+*.swift`

**Testing TCA feature (presentation)?**
→ Use Spies (`NavigationMock`, `UseCaseSpy`) + `lazy var sut = TestStore`

**Testing Use Case/Service (business logic)?**
→ Use real repositories + Mocks for external deps (`FakeHttpService`, `MockFileManager`)

**Need database state?**
→ Use `Database+TestUtils` extensions

**Testing SDK features?**
→ Use Fakes (`FakeDeviceMotionManager`, `MockBarcodeCaptureAdapter`)

---

## File Organization

```
DigitalShelfTests/
├── Utils/
│   ├── TestSamples.swift              # Basic types
│   ├── TestSamples+Models.swift       # Domain models
│   ├── TestSamples+Database.swift     # Database records
│   ├── TestSamples+Network.swift      # Network/API
│   └── TestSamples+Routes.swift       # Routes domain
├── Mocks/
│   ├── KeyValueStorageSpy.swift       # Storage spy
│   ├── FirebaseAnalyticsSpy.swift     # Analytics spy
│   ├── NavigationMock.swift           # Navigation mock+spy
│   ├── FakeHttpService.swift          # HTTP mock+spy
│   ├── MockFileManager.swift          # FileManager mock+spy
│   ├── Dependency+TestDoubles.swift   # TCA defaults
│   └── *Spy.swift / *Mock.swift       # Other spies/mocks
├── Routes/Mocks/
│   └── Route*Spy.swift                # Route-specific spies
├── MappingFlow/*/
│   └── *Spy.swift                     # Mapping-specific spies
└── Extensions/
    ├── Database+TestUtils.swift       # DB test helpers
    ├── TCA+TestExtensions.swift       # TCA helpers
    └── XCTestCase+Extensions.swift    # Common helpers
```

---

## Common Patterns

### Pattern 1: TCA Presentation Test
```swift
lazy var sut = TestStore(initialState: Feature.State()) {
    Feature()
} withDependencies: {
    $0.navigation = NavigationMock()
    $0.useCase = UseCaseSpy()
}

func testUserFlow() async throws {
    await sut.send(.buttonTapped)
    await sut.receive(\.actionReceived)

    XCTAssertEqual(useCase.invokedFetchCount, 1)
}
```

### Pattern 2: Business Integration Test
```swift
func testUseCase() async throws {
    let http = FakeHttpService()
    http.addRequest(endpoint: .products, data: [Product.sample()])

    let sut = UseCase.makeWithDeps(
        repository: RealRepository(httpService: http),
        service: RealService()
    )

    let result = try await sut.fetchData()
    XCTAssertEqual(result.count, 1)
}
```

### Pattern 3: Database Setup
```swift
func setUp() async throws {
    try await super.setUp()
    try db.addSessionRecord(.sample(aisleId: 1))
    try db.addUploadRequestRecord(id: requestId, status: .success)
}
```

---

## Key Principles

1. **Clarity** - Names reveal purpose (`RouteDetailsUseCaseSpy` not `UseCaseMock`)
2. **Actionable** - Examples show exact usage patterns
3. **Concise** - Quick reference, not documentation

**Two-Level Testing:**
- **Presentation (TCA):** Mock ALL dependencies (use spies)
- **Business (Use Cases/Services):** Real business logic + mock external deps only
