# Folder `lib/`

Folder zawierający współdzielone utility functions, helpery i konfiguracje używane w całej aplikacji.

## Pliki

### `error-handling.ts`
Własny system obsługi błędów oparty na Result pattern (Railway Oriented Programming).

#### Typy
- **`ClientResult<T>`** - Result type dla operacji klient/server
  - `{ success: true, isFailure: false, value: T }` - Sukces
  - `{ success: false, isFailure: true, error: string }` - Błąd

- **`ExecutionResult<T, E>`** - Wewnętrzny result type
  - `{ success: true, isFailure: false, value: T }`
  - `{ success: false, isFailure: true, error: E }`

#### Funkcje

**Tworzenie rezultatów:**
```typescript
clientValue<T>(value: T): ClientResult<T>
clientError<T>(msg: string): ClientResult<T>
clientResult<T>(result: ExecutionResult<T, Error>): ClientResult<T>
```

**Bezpieczne wykonywanie kodu:**
```typescript
execute<T, E = Error>(fn: () => T): ExecutionResult<T, E>
executePromise<T, E = Error>(fn: () => Promise<T>): Promise<ExecutionResult<T, E>>
executeValue<T, E = Error>(value: T): ExecutionResult<T, E>
executeError<T, E = Error>(error: E): ExecutionResult<T, E>
```

**Przykład użycia:**
```typescript
// W use case
export function getUserUseCase(context: { getUser: () => User }) {
  const result = execute(() => context.getUser())

  if (!result.success) {
    return clientError("Failed to fetch user")
  }

  return clientValue(result.value)
}

// Async version
async function fetchDataUseCase() {
  const result = await executePromise(async () => await fetchAPI())

  if (result.isFailure) {
    return clientError("API call failed")
  }

  return clientValue(result.value)
}
```

**Zalety:**
- Wymusza obsługę błędów
- Type-safe error handling
- Eliminuje try/catch boilerplate
- Logowanie błędów (console.error)

---

### `utils.ts`
Ogólne utility functions używane w całej aplikacji.

#### Funkcje

**`cn(...inputs: ClassValue[])`**
Utility do łączenia klas CSS (clsx + tailwind-merge).
```typescript
import { cn } from "@/lib/utils"

<div className={cn("base-class", isActive && "active-class", className)} />
```

**`clone(value: any)`**
Deep clone przez JSON serialize/deserialize.
```typescript
const cloned = clone(originalObject)
```

**`unwrapData<T>(data?: T): NonNullable<T>`**
Bezpieczne unwrapowanie danych lub rzucenie błędu.
```typescript
const user = unwrapData(maybeUser) // throws if undefined/null
```

**`stringify(data: any)`**
JSON.stringify wrapper.
```typescript
const json = stringify({ foo: "bar" })
```

**Environment checks:**
```typescript
isServer: boolean  // typeof window === "undefined"
isClient: boolean  // typeof window !== "undefined"
```

---

### `encryption.ts`
Funkcje do szyfrowania/deszyfrowania danych (AES-256-CTR) oraz hashowania (MD5).

#### Konfiguracja
Wymaga zmiennych środowiskowych:
- `ENCRYPT_SECRET_KEY` - 64-char hex string (32 bytes)
- `ENCRYPT_IV` - 32-char hex string (16 bytes)

#### Funkcje

**Szyfrowanie AES-256-CTR:**
```typescript
encrypt(text: string): string
decrypt(hash: string): string
```

**Przykład:**
```typescript
const encrypted = encrypt("sensitive data")
const decrypted = decrypt(encrypted) // "sensitive data"
```

**Hashowanie MD5:**
```typescript
md5(text: string): string
verifyMd5(text: string, hashedText: string): boolean
```

**Przykład:**
```typescript
const hash = md5("password123")
const isValid = verifyMd5("password123", hash) // true
```

**Use cases:**
- Payment order hash (security)
- Sensitive data encryption
- Hashing identifiers

---

### `graph-ql/`
Konfiguracja i utilities dla GraphQL (Strapi CMS).

#### `client.ts`
GraphQL client setup dla połączenia z CMS.

#### `graphql-utils.ts`
Utility functions do pracy z GraphQL queries/mutations.

---

### `emails/`
Email templates i konfiguracja.

#### `order-email.tsx`
React email template dla potwierdzenia zamówienia.

#### `tailwind.email.config.ts`
Tailwind config dla email templates (inline styles).

---

## Technologie

- **clsx** + **tailwind-merge** - Class name utilities
- **crypto** (Node.js) - Encryption/hashing
- **GraphQL** - CMS communication
- **React Email** - Email templates

## Konwencje

### Error Handling Pattern
```typescript
// 1. Execute dangerous operation
const result = await executePromise(async () => await dangerousOp())

// 2. Check result
if (result.isFailure) {
  return clientError("Operation failed")
}

// 3. Return success
return clientValue(result.value)
```

### Encryption Usage
```typescript
// NIGDY nie commituj kluczy do repo
// Użyj .env.local:
// ENCRYPT_SECRET_KEY=your-64-char-hex-string
// ENCRYPT_IV=your-32-char-hex-string

import { encrypt, decrypt } from "@/lib/encryption"

const paymentHash = encrypt(paymentOrderId)
```

## Bezpieczeństwo

⚠️ **Ważne:**
- Klucze szyfrowania muszą być w `.env` (NIGDY w kodzie)
- MD5 nie jest kryptograficznie bezpieczny (użyj dla non-security hashing)
- Dla haseł użyj bcrypt/argon2, nie MD5
- AES-256-CTR wymaga unikalnego IV dla każdej operacji (obecnie shared - do poprawy)

## Import Paths

Wszystkie pliki w `lib/` są dostępne przez alias `@/lib/`:
```typescript
import { cn } from "@/lib/utils"
import { clientValue, clientError } from "@/lib/error-handling"
import { encrypt, decrypt } from "@/lib/encryption"
```
