//  Copyright Â© 2025 Scandit. All rights reserved.

@testable import DigitalShelf
import ComposableArchitecture
import XCTest

typealias ModulePreviewAction = MappingModeModulePreviewFeature.Action

@MainActor
final class MappingModeModulePreviewFeatureTests: XCTestCase {
    // MARK: - Properties

    let sampleModule = ShelfScanModule.existing(details: PersistedShelfScanModule(
        id: 123,
        storeId: 456,
        reference: "M001"
    ))
    let sampleAisle = PersistedShelfScanAisle.sample(id: 789, name: "Aisle A", store: 456)
    let sampleImage = UIImage(systemName: "photo")!

    let useCase = MappingModeModulePreviewUseCaseSpy()
    let analytics = FirebaseAnalyticsSpy()

    lazy var sut = TestStoreOf<MappingModeModulePreviewFeature>(
        initialState: MappingModeModulePreviewFeature.State(
            module: sampleModule,
            aisle: sampleAisle,
            isRetaking: false
        )
    ) {
        MappingModeModulePreviewFeature(useCase: useCase)
    } withDependencies: {
        $0.firebaseAnalytics = analytics
    }

    // MARK: - Setup

    override func setUp() {
        super.setUp()
        useCase.reset()
    }

    // MARK: - State Initialization Tests

    func testStateInitializationShouldSetCorrectInitialValues() async {
        XCTAssertEqual(sut.state.module.moduleId, 123)
        XCTAssertEqual(sut.state.module.moduleReference, "M001")
        XCTAssertEqual(sut.state.aisle.name, "Aisle A")
        XCTAssertFalse(sut.state.isRetaking)
        XCTAssertTrue(sut.state.moduleImage.isIdle)
    }

    // MARK: - Computed Properties Tests

    func testTitleComputedProperty() async {
        XCTAssertEqual(sut.state.title, "Module M001")
    }

    func testModuleGroupNameComputedProperty() async {
        XCTAssertEqual(sut.state.moduleGroupName, "Aisle A")
    }

    // MARK: - OnAppear Tests

    func testOnAppearShouldLogAnalyticsAndLoadPreview() async {
        await sut.send(.onAppear)
        await sut.receive(\.loadModulePreview) {
            $0.moduleImage = .loading
        }

        XCTAssertEqual(analytics.invokedLogCount, 1)
        let loggedEvent = analytics.invokedLogParameterList.first?.event
        XCTAssertEqual(loggedEvent?.name, MappingFlowFirebaseEvent.modulePreviewScreen.event.name)
    }

    // MARK: - LoadModulePreview Tests

    func testLoadModulePreviewWithValidModuleIdShouldSetLoadingAndFetchImage() async {
        useCase.stubbedFreshImage = sampleImage

        await sut.send(.loadModulePreview) {
            $0.moduleImage = .loading
        }

        XCTAssertEqual(useCase.invokedLoadModulePreviewCount, 1)
        XCTAssertEqual(useCase.invokedLoadModulePreviewParameters, 123)

        await sut.receive(\.setModuleImage) {
            $0.moduleImage = .success(self.sampleImage)
        }
    }

    func testLoadModulePreviewWithNilModuleIdShouldReturnNone() async {
        let pendingModule = ShelfScanModule.pending(
            module: PendingShelfScanModule(
                store: 456,
                aisle: sampleAisle,
                moduleReference: "M001",
                order: 1
            )
        )

        let sutWithPendingModule = TestStoreOf<MappingModeModulePreviewFeature>(
            initialState: MappingModeModulePreviewFeature.State(
                module: pendingModule,
                aisle: sampleAisle,
                isRetaking: false
            )
        ) {
            MappingModeModulePreviewFeature(useCase: useCase)
        } withDependencies: {
            $0.firebaseAnalytics = analytics
        }

        await sutWithPendingModule.send(.loadModulePreview)

        XCTAssertEqual(useCase.invokedLoadModulePreviewCount, 0)
        XCTAssertTrue(sutWithPendingModule.state.moduleImage.isIdle)
    }

    func testLoadModulePreviewWithFailureShouldUpdateStateToFailure() async {
        useCase.stubbedError = MappingModulePreviewTestError.noImageConfigured

        await sut.send(.loadModulePreview) {
            $0.moduleImage = .loading
        }

        await sut.receive(\.setModuleImage) {
            $0.moduleImage = .failure
        }
    }

    // MARK: - SetModuleImage Tests

    func testSetModuleImageWithSuccessStateShouldUpdateState() async {
        await sut.send(.setModuleImage(.success(sampleImage))) {
            $0.moduleImage = .success(self.sampleImage)
        }

        XCTAssertTrue(sut.state.moduleImage.isSuccess)
        XCTAssertEqual(sut.state.moduleImage.value, sampleImage)
    }

    func testSetModuleImageWithFailureStateShouldUpdateState() async {
        await sut.send(.setModuleImage(.failure)) {
            $0.moduleImage = .failure
        }

        XCTAssertTrue(sut.state.moduleImage.isFailure)
    }

    func testSetModuleImageWithLoadingStateShouldUpdateState() async {
        await sut.send(.setModuleImage(.loading)) {
            $0.moduleImage = .loading
        }

        XCTAssertTrue(sut.state.moduleImage.isLoading)
    }

    func testSetModuleImageWithRefreshingStateShouldUpdateState() async {
        await sut.send(.setModuleImage(.refreshing(current: sampleImage))) {
            $0.moduleImage = .refreshing(current: self.sampleImage)
        }

        XCTAssertTrue(sut.state.moduleImage.isRefreshing)
        XCTAssertEqual(sut.state.moduleImage.value, sampleImage)
    }

    // MARK: - RefreshImage Tests

    func testRefreshImageWhenNotLoadingShouldReloadImage() async {
        useCase.stubbedFreshImage = sampleImage

        await sut.send(.refreshImage) {
            $0.moduleImage = .loading
        }

        XCTAssertEqual(useCase.invokedLoadModulePreviewCount, 1)

        await sut.receive(\.setModuleImage) {
            $0.moduleImage = .success(self.sampleImage)
        }
    }

    func testRefreshImageWhenAlreadyLoadingShouldReturnNone() async {
        await sut.send(.setModuleImage(.loading)) {
            $0.moduleImage = .loading
        }

        await sut.send(.refreshImage)

        XCTAssertEqual(useCase.invokedLoadModulePreviewCount, 0)
    }

    func testRefreshImageWithSuccessStateShouldKeepCurrentImageDuringRefresh() async {
        useCase.stubbedFreshImage = sampleImage

        await sut.send(.setModuleImage(.success(sampleImage))) {
            $0.moduleImage = .success(self.sampleImage)
        }

        await sut.send(.refreshImage) {
            $0.moduleImage = .refreshing(current: self.sampleImage)
        }

        XCTAssertEqual(useCase.invokedLoadModulePreviewCount, 1)

        await sut.receive(\.setModuleImage) {
            $0.moduleImage = .success(self.sampleImage)
        }
    }

    func testRefreshImageWithFailureStateShouldSetLoadingState() async {
        useCase.stubbedFreshImage = sampleImage

        await sut.send(.setModuleImage(.failure)) {
            $0.moduleImage = .failure
        }

        await sut.send(.refreshImage) {
            $0.moduleImage = .loading
        }

        await sut.receive(\.setModuleImage) {
            $0.moduleImage = .success(self.sampleImage)
        }
    }

    func testRefreshImageWithNilModuleIdShouldReturnNone() async {
        let pendingModule = ShelfScanModule.pending(
            module: PendingShelfScanModule(
                store: 456,
                aisle: sampleAisle,
                moduleReference: "M001",
                order: 1
            )
        )

        let sutWithPendingModule = TestStoreOf<MappingModeModulePreviewFeature>(
            initialState: MappingModeModulePreviewFeature.State(
                module: pendingModule,
                aisle: sampleAisle,
                isRetaking: false
            )
        ) {
            MappingModeModulePreviewFeature(useCase: useCase)
        } withDependencies: {
            $0.firebaseAnalytics = analytics
        }

        await sutWithPendingModule.send(.refreshImage)

        XCTAssertEqual(useCase.invokedLoadModulePreviewCount, 0)
    }

    // MARK: - OnContinueButtonTapped Tests

    func testOnContinueButtonTappedShouldLogAnalytics() async {
        await sut.send(.onContinueButtonTapped)

        XCTAssertEqual(analytics.invokedLogCount, 1)
        let loggedEvent = analytics.invokedLogParameterList.first?.event
        XCTAssertEqual(loggedEvent?.name, MappingFlowFirebaseEvent.continueButton.event.name)
    }

    // MARK: - Analytics Tests

    func testAnalyticsActionShouldLogEvent() async {
        let customEvent = MappingFlowFirebaseEvent.modulePreviewScreen

        await sut.send(.analytics(event: customEvent))

        XCTAssertEqual(analytics.invokedLogCount, 1)
        let loggedEvent = analytics.invokedLogParameterList.first?.event
        XCTAssertEqual(loggedEvent?.name, customEvent.event.name)
    }

    // MARK: - ViewDisappeared Tests

    func testViewDisappearedShouldCancelPendingOperations() async {
        useCase.stubbedFreshImage = sampleImage

        await sut.send(.loadModulePreview) {
            $0.moduleImage = .loading
        }

        // Handle the result first (task completes quickly in tests)
        await sut.receive(\.setModuleImage) {
            $0.moduleImage = .success(self.sampleImage)
        }

        // Then send viewDisappeared
        await sut.send(.viewDisappeared)

        XCTAssertEqual(useCase.invokedLoadModulePreviewCount, 1)
    }

    // MARK: - Integration Tests

    func testCompleteUserFlowFromAppearToContinue() async {
        useCase.stubbedFreshImage = sampleImage

        await sut.send(.onAppear)

        XCTAssertEqual(analytics.invokedLogCount, 1)

        await sut.receive(\.loadModulePreview) {
            $0.moduleImage = .loading
        }

        await sut.receive(\.setModuleImage) {
            $0.moduleImage = .success(self.sampleImage)
        }

        await sut.send(.onContinueButtonTapped)

        XCTAssertEqual(analytics.invokedLogCount, 2)
    }

    func testRetryFlowAfterInitialFailure() async {
        useCase.stubbedError = MappingModulePreviewTestError.noImageConfigured

        await sut.send(.loadModulePreview) {
            $0.moduleImage = .loading
        }

        await sut.receive(\.setModuleImage) {
            $0.moduleImage = .failure
        }

        XCTAssertTrue(sut.state.moduleImage.isFailure)

        useCase.stubbedError = nil
        useCase.stubbedFreshImage = sampleImage

        await sut.send(.refreshImage) {
            $0.moduleImage = .loading
        }

        await sut.receive(\.setModuleImage) {
            $0.moduleImage = .success(self.sampleImage)
        }

        XCTAssertTrue(sut.state.moduleImage.isSuccess)
    }

    func testMultipleRefreshAttempts() async {
        useCase.stubbedFreshImage = sampleImage

        await sut.send(.setModuleImage(.success(sampleImage))) {
            $0.moduleImage = .success(self.sampleImage)
        }

        await sut.send(.refreshImage) {
            $0.moduleImage = .refreshing(current: self.sampleImage)
        }
        await sut.receive(\.setModuleImage) {
            $0.moduleImage = .success(self.sampleImage)
        }

        XCTAssertEqual(useCase.invokedLoadModulePreviewCount, 1)

        await sut.send(.refreshImage) {
            $0.moduleImage = .refreshing(current: self.sampleImage)
        }
        await sut.receive(\.setModuleImage) {
            $0.moduleImage = .success(self.sampleImage)
        }

        XCTAssertEqual(useCase.invokedLoadModulePreviewCount, 2)
    }
}
